// ==UserScript==
// @name         Soundcloud Downloader Clean
// @namespace    https://openuserjs.org/users/webketje
// @version      1.0.0
// @description  An ad-less, multilingual, clean Soundcloud downloader with robust code. Adds a 'Download' button in the toolbar of all single track views.
// @author       webketje
// @license      MIT
// @icon         https://a-v2.sndcdn.com/assets/images/sc-icons/favicon-2cadd14bdb.ico
// @homepageURL  https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6
// @supportURL   https://gist.github.com/webketje/8cd2e6ae8a86dbe0533c5d2c612c42c6#comments
// @noframes
// @match        https://soundcloud.com/*
// @grant        unsafeWindow
// @require      https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Soundcloud20Downloader20Clean.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Soundcloud20Downloader20Clean.meta.js
// ==/UserScript==
!function(){"use strict";var e=unsafeWindow||window,t=".soundActions.sc-button-toolbar .sc-button-group",o={debug:!1,client_id:"",dlButtonId:"scdlc-btn",modalId:"scdl-third-party-modal"},n={en:{download:"Download",downloading:"Downloading",copy:"Copy",copy_success:"Copied to clipboard",copy_failure:"Failed to copy to clipboard!",close:"Close",modal_title:"could not download this track. Use one of these third-party services instead?"},es:{download:"Descargar",downloading:"Descargando..",copy:"Copiar",copy_success:"Copiada al portapapeles",copy_failure:"¡No se pudo copiar al portapapeles!",close:"",modal_title:"no se pudo descargar esta banda sonora. ¿Utilizar uno de estos servicios de terceros en su lugar?"},fr:{download:"Télécharger",downloading:"Téléchargement..",copy:"Copier",copy_success:"Copié dans le presse-papiers!",copy_failure:"Échec de la copie dans le presse-papiers !",close:"Fermer",modal_title:"ne peut pas télécharger ce fichier. Utiliser l’un de ces services tiers ?"},nl:{download:"Downloaden",downloading:"Downloaden..",copy:"Kopiëren",copy_success:"Naar klembord gekopieerd!",copy_failure:"Kopiëren naar klembord mislukt!",close:"Sluiten",modal_title:"kon dit bestand niet downloaden. Een van deze externe diensten gebruiken?"},de:{download:"Herunterladen",downloading:"Herunterladen..",copy:"Kopieren",copy_success:"In die Zwischenablage kopiert",copy_failure:"Kopieren in die Zwischenablage fehlgeschlagen!",close:"Schließen",modal_title:"konnte diesen Sound nicht herunterladen. Nutzen Sie stattdessen einen dieser Drittanbieterdienste?"},pl:{download:"Ściągnij",downloading:"Ściąganie..",copy:"Kopiuj",copy_success:"Skopiowano do schowka",copy_failure:"Nie udało się skopiować do schowka!!",close:"Zamknij",modal_title:"nie udało się pobrać tego utworu. Zamiast tego skorzystać z jednej z usług stron trzecich?"},it:{download:"Scaricare",downloading:"Scaricando..",copy:"Copia",copy_success:"Copiato negli appunti",copy_failure:"Impossibile copiare negli appunti!",close:"Chiudi",modal_title:"non è stato possibile scaricare questo suono. Utilizzi invece uno di questi servizi di terze parti?"},pt_BR:{download:"Baixar",downloading:"Baixando..",copy:"Copiar",copy_success:"Copiado para a área de transferência",copy_failure:"Falha ao copiar para a área de transferência!!",close:"Fechar",modal_title:"não foi possível baixar este som. Usar um desses serviços de terceiros?"},sv:{download:"Ladda ner",downloading:"Laddar ner..",copy:"Kopiera",copy_success:"Kopierat till urklipp",copy_failure:"Det gick inte att kopiera till urklipp!",close:"Stäng",modal_title:"han kunde inte ladda ner det här ljudet. Använd någon av dessa tredjepartstjänster istället?"}}[document.documentElement.lang||"en"];function a(){var e=(new Date).toLocaleString(),t=[].slice.call(arguments),n=["SCDLC",e,"-"].join(" ");o.debug&&console.log.apply(console,[n+t[0]].concat(t.slice(1)))}o.getTrackName=function(e){return[e.user.username,e.title].join(" - ")},o.getMediaURL=function(e,t,n){if(e.media&&e.media.transcodings){var a=e.media.transcodings.filter((function(e){return e.format&&"progressive"===e.format.protocol}))[0];if(a){var i=new XMLHttpRequest;i.onload=function(){var e;try{e=JSON.parse(i.responseText)}catch(e){}e&&e.url?t(e.url):n(!1)},i.onerror=n,i.open("GET",a.url+"?client_id="+o.client_id),i.send()}else n(!1)}else n(!1)},o.getStreamURL=function(e,t,n){var a=new XMLHttpRequest;a.onload=function(){var e=JSON.parse(a.responseText);o.getMediaURL(e,(function(n){t({stream_url:n,track_name:o.getTrackName(e)})}),(function(){n(!1)}))}.bind(this),a.onerror=function(){n(!1)},a.open("GET","https://api-v2.soundcloud.com/resolve?url="+encodeURIComponent(e)+"&client_id="+this.client_id),a.send()},o.button={download:function(e){e.preventDefault();var t=document.getElementById(o.dlButtonId);t&&(t.textContent=n.downloading),setTimeout((function(){saveAs(e.target.href,e.target.dataset.title),t&&(t.textContent=n.download)}),100)},render:function(e,t,a){var i=n.download,r=document.createElement("a");return r.className="sc-button sc-button-medium sc-button-responsive sc-button-download",r.href=e,r.id=o.dlButtonId,r.textContent=i,r.title=i,r.dataset.title=t+".mp3",r.setAttribute("download",t+".mp3"),r.target="_blank",r.onclick=a,r.style.marginLeft="5px",r.style.cssFloat="left",r.style.border="1px solid orangered",r},attach:function(){var e=arguments,n=this,i=0,r=setInterval((function(){var s=document.querySelector(t);i++,s&&!document.getElementById(o.dlButtonId)?(s.insertAdjacentElement("beforeend",n.render.apply(n,e)),a("Attaching download button to element:",s),clearInterval(r)):50===i&&(a("%c Couldn't find element \""+t+'" after 2 seconds',"color: #FF0000;"),clearInterval(r))}),100)},remove:function(){var e=document.getElementById(o.dlButtonId);e&&e.parentNode.removeChild(e)}},o.modal={providers:["aHR0cHM6Ly9zY2xvdWRkb3dubG9hZGVyLm5ldA==","aHR0cHM6Ly93d3cuc291bmRjbG91ZG1wMy5vcmc=","aHR0cHM6Ly9zb3VuZGNsb3VkbWUuY29t"],render:function(t){var o=document.createElement("div"),i=this;const r=['<div class="modal g-z-index-modal-background g-opacity-transition g-z-index-overlay modalWhiteout showBackground g-backdrop-filter-grayscale" style="outline: none; padding-right: 0px; display: flex; justify-content: center;" tabindex="-1" id="scdl-third-party-modal">','<div class="modal__modal sc-border-box g-z-index-modal-content transparentBackground" style="height: auto;">','<button type="button" title="'+n.close+'" class="modal__closeButton">'+n.close+"</button>",'<div class="modal__content"><div class="tabs"><div class="tabs__content"><div class="tabs__contentSlot" style="display: block;"><article class="shareContent">','<div class="publicShare"><section class="g-modal-section sc-clearfix sc-pt-2x">','<h2 class="sc-orange">Soundcloud Downloader Clean '+n.modal_title+"</h2>",'</section><section class="g-modal-section sc-clearfix sc-pt-2x">','<h3 style="margin-bottom: 0.5rem;">'+n.download+" <em>"+t+"</em> via: </h3>",this.providers.map((t=>['<div><a href="',e.atob(t),'" target="_blank" style="display: inline-block; font-size: 14px; padding: 0.25rem 0;">',e.atob(t),"</a></div>"].join(""))).join(""),'<div class="shareLink sc-clearfix publicShare__link sc-pt-2x m-showPositionOption" style="margin-top: 1rem;">','<label for="shareLink__field" style="margin-right:0.5rem;">Link</label>','<input type="text" value="'+e.location.href+'" class="shareLink__field sc-input" id="shareLink__field" readonly="readonly">','<button class="sc-button sc-button-copy">'+n.copy+"</button>",'<span class="sc-copy-feedback" style="margin-left: 1rem;"></span>',"</div>","</section></div></article></div></div></div></div></div></div>"].join("");o.innerHTML=r;var s=o.firstElementChild;return s.addEventListener("click",(function(t){this===t.target||t.target.classList.contains("modal__closeButton")?i.remove():t.target.classList.contains("sc-button-copy")&&navigator.clipboard.writeText(e.location.href).then((function(){s.querySelector(".sc-copy-feedback").innerHTML='<span style="color: green;">Copied to clipboard!</span>'}),(function(e){a("Failed to write URL to the clipboard.",e),s.querySelector(".sc-copy-feedback").innerHTML='<span style="color: red;">Failed to copy to clipboard!</span>'}))})),s},attach:function(){this.remove(),document.body.appendChild(this.render.apply(this,arguments))},remove:function(){var e=document.getElementById(o.modalId);e&&e.parentNode.removeChild(e)}},o.parseClientIdFromURL=function(e){var t=/client_id=([\w\d]+)&*/;return e&&e.match(t)&&e.match(t)[1]},o.getClientID=function(t){var n,a,i;n=function(e,t){return o.parseClientIdFromURL(t)},a=t,i=e.XMLHttpRequest.prototype.open,e.XMLHttpRequest.prototype.open=function(){i.apply(this,arguments);var t=n.apply(this,arguments);t&&(e.XMLHttpRequest.prototype.open=i,a(t))}},o.load=function(t){/^(\/(you|stations|discover|stream|upload|search|settings|.+?\/sets))/.test(e.location.pathname)?o.button.remove():o.getStreamURL(t,(function(e){e?(a("Detected valid Soundcloud artist track URL. Requesting info..."),o.button.attach(e.stream_url,e.track_name,o.button.download)):o.button.remove()}),(function(){a("%c No compatible media transcoding found.","color: #FF0000;"),o.button.attach("javascript:void(0);","None",(function(){var e=document.querySelector(".soundTitle__title"),t=document.querySelector(".soundTitle__username");o.modal.attach([t.textContent.trim(),"-",e.textContent.trim()].join(" "))}))}))},["pushState","replaceState","forward","back","go"].forEach((function(t){var n=e.history.pushState;e.history[t]=function(){n.apply(e.history,arguments),o.load(e.location.href)}})),o.debug&&(e.scdl=o),o.getClientID((function(t){a("Found Soundcloud client id:",t,". Initializing..."),o.client_id=t,o.load(e.location.href)}))}();