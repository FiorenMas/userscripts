// ==UserScript==
// @name         DownloadAllContent
// @namespace    hoothin
// @version      2.8.3.15
// @description  Lightweight web scraping script. Fetch and download main textual content from the current page, provide special support for novels
// @author       hoothin
// @match        http://*/*
// @match        https://*/*
// @match        ftp://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @grant        GM_setClipboard
// @grant        GM_addStyle
// @grant        unsafeWindow
// @license      MIT License
// @compatible        chrome
// @compatible        firefox
// @compatible        opera 未测试
// @compatible        safari 未测试
// @contributionURL https://ko-fi.com/hoothin
// @contributionAmount 1
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/DownloadAllContent.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/DownloadAllContent.meta.js
// ==/UserScript==
if(window.top!=window.self)try{if(window.self.innerWidth<250||window.self.innerHeight<250)return}catch(e){return}!function(e,t){if("function"==typeof define&&define.amd)define([],t);else if("undefined"!=typeof exports)t();else{t(),e.FileSaver={}}}(this,(function(){"use strict";var e="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0;function t(e,t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="blob",r.onload=function(){a(r.response,t,n)},r.onerror=function(){console.error("could not download file")},r.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return t.status>=200&&t.status<=299}function r(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o=e.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),a=e.saveAs||("object"!=typeof window||window!==e?function(){}:"download"in HTMLAnchorElement.prototype&&!o?function(o,a,i){var l=e.URL||e.webkitURL,s=document.createElement("a");a=a||o.name||"download",s.download=a,s.rel="noopener","string"==typeof o?(s.href=o,s.origin!==location.origin?n(s.href)?t(o,a,i):r(s,s.target="_blank"):r(s)):(s.href=l.createObjectURL(o),setTimeout((function(){l.revokeObjectURL(s.href)}),4e4),setTimeout((function(){r(s)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,o,a){if(o=o||e.name||"download","string"==typeof e)if(n(e))t(e,o,a);else{var i=document.createElement("a");i.href=e,i.target="_blank",setTimeout((function(){r(i)}))}else navigator.msSaveOrOpenBlob(function(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e}(e,a),o)}:function(n,r,a,i){if((i=i||open("","_blank"))&&(i.document.title=i.document.body.innerText="downloading..."),"string"==typeof n)return t(n,r,a);var l="application/octet-stream"===n.type,s=/constructor/i.test(e.HTMLElement)||e.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||l&&s||o)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=c?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=e:location=e,i=null},d.readAsDataURL(n)}else{var D=e.URL||e.webkitURL,u=D.createObjectURL(n);i?i.location=u:location.href=u,i=null,setTimeout((function(){D.revokeObjectURL(u)}),4e4)}});e.saveAs=a.saveAs=a,"undefined"!=typeof module&&(module.exports=a)})),function(){"use strict";var indexReg=/^(\w.*)?PART\b|^Prologue|^(\w.*)?Chapter\s*[\-_]?\d+|分卷|^序$|^序\s*[·言章]|^前\s*言|^附\s*[录錄]|^引\s*[言子]|^摘\s*要|^[楔契]\s*子|^后\s*记|^後\s*記|^附\s*言|^结\s*语|^結\s*語|^尾\s*[声聲]|^最終話|^最终话|^番\s*外|^\d+[\s\.、,，）\-_：:][^\d#\.]|^(\d|\s|\.)*[第（]?\s*[\d〇零一二两三四五六七八九十百千万萬-]+\s*[、）章节節回卷折篇幕集话話]/i,innerNextPage=/^\s*(下一[页頁张張]|next\s*page|次のページ)/i,lang="Netscape"==navigator.appName?navigator.language:navigator.userLanguage,i18n={},rCats=[],processFunc,nextPageFunc;const AsyncFunction=Object.getPrototypeOf((async function(){})).constructor;var win="undefined"==typeof unsafeWindow?window:unsafeWindow;switch(lang){case"zh-CN":case"zh-SG":i18n={fetch:"开始下载小说",info:"来源：#t#\n本文是使用怠惰小说下载器（DownloadAllContent）下载的",error:"该段内容获取失败",downloading:"已下载完成 %s 段，剩余 %s 段<br>正在下载 %s",complete:"已全部下载完成，共 %s 段",del:"设置文本干扰码的CSS选择器",custom:"自定规则下载",customInfo:"输入网址或者章节CSS选择器",reSort:"按标题名重新排序章节",reSortUrl:"按网址重新排序章节",setting:"选项参数设置",searchRule:"搜索网站规则",abort:"跳过此章",save:"保存当前",saveAsMd:"存为 Markdown",saveAsJSON:"存为 JSON",downThreadNum:"设置同时下载的线程数，负数为单线程下载间隔",enableTouch:"在移动端按→↓←↑的方向滑动屏幕画正方形立即开始下载",customTitle:"自定义章节标题，输入内页文字对应选择器",saveUrl:"储存 URL",disableAutoStartSave:"禁用自动保存",maxDlPerMin:"每分钟最大下载数",reSortDefault:"默认按页面中位置排序章节",reverseOrder:"反转章节排序",saveBtn:"保存设置",saveOk:"保存成功",nextPage:"嗅探章节内分页",nextPageReg:"自定义分页正则",retainImage:"保留正文中图片的网址",minTxtLength:"当检测到的正文字数小于此数，则尝试重新抓取",showFilterList:"下载前显示章节筛选排序窗口",ok:"确定",close:"关闭",dacSortByPos:"按页内位置排序",dacSortByUrl:"按网址排序",dacSortByName:"按章节名排序",reverse:"反选",dacUseIframe:"使用 iframe 后台加载内容（慢速）",dacSaveAsZip:"下载为 zip",dacSetCustomRule:"修改规则",dacAddUrl:"添加章节",prefix:"给章节名称添加前缀",dacStartDownload:"下载选中",downloadShortcut:"下载章节快捷键",downloadSingleShortcut:"下载单页快捷键",downloadCustomShortcut:"自定义下载快捷键"};break;case"zh":case"zh-TW":case"zh-HK":i18n={fetch:"開始下載小說",info:"來源：#t#\n本文是使用怠惰小說下載器（DownloadAllContent）下載的",error:"該段內容獲取失敗",downloading:"已下載完成 %s 段，剩餘 %s 段<br>正在下載 %s",complete:"已全部下載完成，共 %s 段",del:"設置文本干擾碼的CSS選擇器",custom:"自訂規則下載",customInfo:"輸入網址或者章節CSS選擇器",reSort:"按標題名重新排序章節",reSortUrl:"按網址重新排序章節",setting:"選項參數設定",searchRule:"搜尋網站規則",abort:"跳過此章",save:"保存當前",saveAsMd:"存爲 Markdown",saveAsJSON:"存爲 JSON",downThreadNum:"設置同時下載的綫程數，負數為單線程下載間隔",enableTouch:"在行動端按→↓←↑的方向滑動螢幕畫方立即開始下載",customTitle:"自訂章節標題，輸入內頁文字對應選擇器",saveUrl:"儲存 URL",disableAutoStartSave:"禁用自動保存",maxDlPerMin:"每分鐘最大下載數",reSortDefault:"預設依頁面中位置排序章節",reverseOrder:"反轉章節排序",saveBtn:"儲存設定",saveOk:"儲存成功",nextPage:"嗅探章節內分頁",nextPageReg:"自訂分頁正規",retainImage:"保留內文圖片的網址",minTxtLength:"當偵測到的正文字數小於此數，則嘗試重新抓取",showFilterList:"下載前顯示章節篩選排序視窗",ok:"確定",close:"關閉",dacSortByPos:"依頁內位置排序",dacSortByUrl:"依網址排序",dacSortByName:"依章節名排序",reverse:"反選",dacUseIframe:"使用 iframe 背景載入內容（慢速）",dacSaveAsZip:"下載為 zip",dacSetCustomRule:"修改規則",dacAddUrl:"新增章節",prefix:"為章節名稱加上前綴",dacStartDownload:"下載選取",downloadShortcut:"下載章節快速鍵",downloadSingleShortcut:"下載單頁快速鍵",downloadCustomShortcut:"自設下載快速鍵"};break;case"ar":case"ar-AE":case"ar-BH":case"ar-DZ":case"ar-EG":case"ar-IQ":case"ar-JO":case"ar-KW":case"ar-LB":case"ar-LY":case"ar-MA":case"ar-OM":case"ar-QA":case"ar-SA":case"ar-SY":case"ar-TN":case"ar-YE":i18n={encode:!0,fetch:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84",info:"%D8%A7%D9%84%D9%85%D8%B5%D8%AF%D8%B1:%20#t#%0A%D8%AA%D9%85%20%D8%AA%D9%86%D8%B2%D9%8A%D9%84%20%D8%A7%D9%84%D9%80%20TXT%20%D8%A8%D9%88%D8%A7%D8%B3%D8%B7%D8%A9%20'DownloadAllContent'",error:"%D9%81%D8%B4%D9%84%20%D9%81%D9%8A%20%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D8%A7%D9%84%D9%81%D8%B5%D9%84%20%D8%A7%D9%84%D8%AD%D8%A7%D9%84%D9%8A",downloading:"......%25s%20%D8%AA%D8%AD%D9%85%D9%8A%D9%84%3Cbr%3E%D8%B5%D9%81%D8%AD%D8%A7%D8%AA%20%D9%85%D8%AA%D8%A8%D9%82%D9%8A%D8%A9%20%25s%20%D8%B5%D9%81%D8%AD%D8%A7%D8%AA%20%D8%AA%D9%85%20%D8%AA%D8%AD%D9%85%D9%8A%D9%84%D9%87%D8%A7%D8%8C%20%D9%87%D9%86%D8%A7%D9%83%20%25s",complete:"%D8%B5%D9%81%D8%AD%D8%A7%D8%AA%20%D9%81%D9%8A%20%D8%A7%D9%84%D9%85%D8%AC%D9%85%D9%88%D8%B9%20%25s%20%D8%A7%D9%83%D8%AA%D9%85%D9%84!%20%D8%AD%D8%B5%D9%84%D8%AA%20%D8%B9%D9%84%D9%89",del:"%D9%84%D8%AA%D8%AC%D8%A7%D9%87%D9%84%20CSS%20%D8%AA%D8%B9%D9%8A%D9%8A%D9%86%20%D9%85%D8%AD%D8%AF%D8%AF%D8%A7%D8%AA",custom:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D9%85%D8%AE%D8%B5%D8%B5",customInfo:"%D9%84%D8%B1%D9%88%D8%A7%D8%A8%D8%B7%20%D8%A7%D9%84%D9%81%D8%B5%D9%88%D9%84%20sss%20%D8%A5%D8%AF%D8%AE%D8%A7%D9%84%20%D8%A7%D9%84%D8%B1%D9%88%D8%A7%D8%A8%D8%B7%20%D8%A3%D9%88%20%D9%85%D8%AD%D8%AF%D8%AF%D8%A7%D8%AA",reSort:"%D8%A5%D8%B9%D8%A7%D8%AF%D8%A9%20%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D8%B9%D9%86%D9%88%D8%A7%D9%86",reSortUrl:"%D8%A5%D8%B9%D8%A7%D8%AF%D8%A9%20%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D8%B1%D9%88%D8%A7%D8%A8%D8%B7",setting:"%D9%81%D8%AA%D8%AD%20%D8%A7%D9%84%D8%A5%D8%B9%D8%AF%D8%A7%D8%AF%D8%A7%D8%AA",searchRule:"%D9%82%D8%A7%D8%B9%D8%AF%D8%A9%20%D8%A7%D9%84%D8%A8%D8%AD%D8%AB",abort:"%D8%A5%D9%8A%D9%82%D8%A7%D9%81",save:"%D8%AD%D9%81%D8%B8",saveAsMd:"Markdown%20%D8%AD%D9%81%D8%B8%20%D9%83%D9%80",saveAsJSON:"JSON%20%D8%AD%D9%81%D8%B8%20%D9%83%D9%80",downThreadNum:"%D8%AA%D8%B9%D9%8A%D9%8A%D9%86%20%D8%B9%D8%AF%D8%AF%20%D8%A7%D9%84%D8%AE%D9%8A%D9%88%D8%B7%20%D9%84%D9%84%D8%AA%D8%AD%D9%85%D9%8A%D9%84",enableTouch:"On%20the%20mobile%20device,%20slide%20the%20screen%20in%20the%20direction%20of%20%E2%86%92%E2%86%93%E2%86%90%E2%86%91%20to%20draw%20a%20square%20will%20start%20downloading%20immediately",customTitle:"%D8%AA%D8%AE%D8%B5%D9%8A%D8%B5%20%D8%B9%D9%86%D9%88%D8%A7%D9%86%20%D8%A7%D9%84%D9%81%D8%B5%D9%84%D8%8C%20%D8%A5%D8%AF%D8%AE%D8%A7%D9%84%20%D8%A7%D9%84%D9%85%D8%AD%D8%AF%D8%AF%20%D9%81%D9%8A%20%D8%A7%D9%84%D8%B5%D9%81%D8%AD%D8%A9%20%D8%A7%D9%84%D8%AF%D8%A7%D8%AE%D9%84%D9%8A%D8%A9",saveUrl:"%D8%AD%D9%81%D8%B8%20URL",disableAutoStartSave:"%D8%AA%D8%B9%D8%B7%D9%8A%D9%84%20%D8%A7%D9%84%D8%AD%D9%81%D8%B8%20%D8%A7%D9%84%D8%AA%D9%84%D9%82%D8%A7%D8%A6%D9%8A",maxDlPerMin:"%D8%A7%D9%84%D8%AD%D8%AF%20%D8%A7%D9%84%D8%A3%D9%82%D8%B5%D9%89%20%D9%84%D8%B9%D8%AF%D8%AF%20%D8%A7%D9%84%D8%AA%D9%86%D8%B2%D9%8A%D9%84%D8%A7%D8%AA%20%D9%81%D9%8A%20%D8%A7%D9%84%D8%AF%D9%82%D9%8A%D9%82%D8%A9",reSortDefault:"%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%A7%D9%84%D8%A7%D9%81%D8%AA%D8%B1%D8%A7%D8%B6%D9%8A%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D9%85%D9%88%D9%82%D8%B9%20%D9%81%D9%8A%20%D8%A7%D9%84%D8%B5%D9%81%D8%AD%D8%A9",reverseOrder:"%D8%B9%D9%83%D8%B3%20%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%A7%D9%84%D9%81%D8%B5%D9%88%D9%84",saveBtn:"%D8%AD%D9%81%D8%B8%20%D8%A7%D9%84%D8%A5%D8%B9%D8%AF%D8%A7%D8%AF%D8%A7%D8%AA",saveOk:"%D8%AA%D9%85%20%D8%A7%D9%84%D8%AD%D9%81%D8%B8",nextPage:"%D8%A7%D9%84%D8%AA%D8%AD%D9%82%D9%82%20%D9%85%D9%86%20%D8%A7%D9%84%D8%B5%D9%81%D8%AD%D8%A9%20%D8%A7%D9%84%D8%AA%D8%A7%D9%84%D9%8A%D8%A9%20%D9%81%D9%8A%20%D8%A7%D9%84%D9%81%D8%B5%D9%84",nextPageReg:"%D9%85%D8%AE%D8%B5%D8%B5%20%D9%84%D9%84%D8%B5%D9%81%D8%AD%D8%A9%20%D8%A7%D9%84%D8%AA%D8%A7%D9%84%D9%8A%D8%A9%20RegExp",retainImage:"%D8%A7%D9%84%D8%A7%D8%AD%D8%AA%D9%81%D8%A7%D8%B8%20%D8%A8%D8%B9%D9%86%D9%88%D8%A7%D9%86%20%D8%A7%D9%84%D8%B5%D9%88%D8%B1%D8%A9%20%D8%A5%D8%B0%D8%A7%20%D9%83%D8%A7%D9%86%D8%AA%20%D9%87%D9%86%D8%A7%D9%83%20%D8%B5%D9%88%D8%B1%20%D9%81%D9%8A%20%D8%A7%D9%84%D9%86%D8%B5",minTxtLength:"%D8%A7%D9%84%D9%85%D8%AD%D8%A7%D9%88%D9%84%D8%A9%20%D9%85%D8%B1%D8%A9%20%D8%A3%D8%AE%D8%B1%D9%89%20%D8%B9%D9%86%D8%AF%D9%85%D8%A7%20%D9%8A%D9%83%D9%88%D9%86%20%D8%B7%D9%88%D9%84%20%D8%A7%D9%84%D9%85%D8%AD%D8%AA%D9%88%D9%89%20%D8%A3%D9%82%D9%84%20%D9%85%D9%86%20%D9%87%D8%B0%D8%A7",showFilterList:"%D8%B9%D8%B1%D8%B6%20%D9%86%D8%A7%D9%81%D8%B0%D8%A9%20%D8%A7%D9%84%D8%AA%D8%B5%D9%81%D9%8A%D8%A9%20%D9%88%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D9%82%D8%A8%D9%84%20%D8%A7%D9%84%D8%AA%D8%AD%D9%85%D9%8A%D9%84",ok:"%D9%85%D9%88%D8%A7%D9%81%D9%82",close:"%D8%A5%D8%BA%D9%84%D8%A7%D9%82",dacSortByPos:"%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D9%85%D9%88%D9%82%D8%B9",dacSortByUrl:"%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D8%B1%D8%A7%D8%A8%D8%B7",dacSortByName:"%D8%A7%D9%84%D8%AA%D8%B1%D8%AA%D9%8A%D8%A8%20%D8%AD%D8%B3%D8%A8%20%D8%A7%D9%84%D8%A7%D8%B3%D9%85",reverse:"%D8%B9%D9%83%D8%B3%20%D8%A7%D9%84%D8%A7%D8%AE%D8%AA%D9%8A%D8%A7%D8%B1",dacUseIframe:"%D9%84%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D8%A7%D9%84%D9%85%D8%AD%D8%AA%D9%88%D9%89%20(%D8%A8%D8%B7%D9%8A%D8%A1)%20iframe%20%D8%A7%D8%B3%D8%AA%D8%AE%D8%AF%D8%A7%D9%85",dacSaveAsZip:"zip%20%D8%AD%D9%81%D8%B8%20%D9%83%D9%80",dacSetCustomRule:"%D8%AA%D8%B9%D8%AF%D9%8A%D9%84%20%D8%A7%D9%84%D9%82%D9%88%D8%A7%D8%B9%D8%AF",dacAddUrl:"%D8%A5%D8%B6%D8%A7%D9%81%D8%A9%20%D9%81%D8%B5%D9%84",prefix:"Prefix%20of%20chapter%20name",dacStartDownload:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D8%A7%D9%84%D9%85%D8%AD%D8%AF%D8%AF",downloadShortcut:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D8%A7%D9%84%D9%81%D8%B5%D9%84",downloadSingleShortcut:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D8%B5%D9%81%D8%AD%D8%A9%20%D9%88%D8%A7%D8%AD%D8%AF%D8%A9",downloadCustomShortcut:"%D8%AA%D8%AD%D9%85%D9%8A%D9%84%20%D9%85%D8%AE%D8%B5%D8%B5"};break;default:i18n={fetch:"Download",info:"Source: #t#\nThe TXT is downloaded by 'DownloadAllContent'",error:"Failed in downloading current chapter",downloading:"%s pages are downloaded, there are still %s pages left<br>Downloading %s ......",complete:"Completed! Get %s pages in total",del:"Set css selectors for ignore",custom:"Custom to download",customInfo:"Input urls OR sss selectors for chapter links",reSort:"ReSort by title",reSortUrl:"Resort by URLs",setting:"Open Setting",searchRule:"Search rule",abort:"Abort",save:"Save",saveAsMd:"Save as Markdown",saveAsJSON:"Save as JSON",downThreadNum:"Set threadNum for download, negative means interval of single thread",enableTouch:"On the mobile device, slide the screen in the direction of →↓←↑ to draw a square will start downloading immediately",customTitle:"Customize the chapter title, enter the selector on inner page",saveUrl:"Save URL",disableAutoStartSave:"Disable auto save",maxDlPerMin:"Maximum number of downloads per minute",reSortDefault:"Default sort by position in the page",reverseOrder:"Reverse chapter ordering",saveBtn:"Save Setting",saveOk:"Save Over",nextPage:"Check next page in chapter",nextPageReg:"Custom RegExp of next page",retainImage:"Keep the URL of image if there are images in the text",minTxtLength:"Try to crawl again when the length of content is less than this",showFilterList:"Show chapter filtering and sorting window before downloading",ok:"OK",close:"Close",dacSortByPos:"Sort by position",dacSortByUrl:"Sort by URL",dacSortByName:"Sort by name",reverse:"Reverse selection",dacUseIframe:"Use iframe to load content (slow)",dacSaveAsZip:"Save as zip",dacSetCustomRule:"Modify rules",dacAddUrl:"Add Chapter",prefix:"Prefix of chapter name",dacStartDownload:"Download selected",downloadShortcut:"Download chapter Shortcut",downloadSingleShortcut:"Download single page Shortcut",downloadCustomShortcut:"Custom download Shortcut"}}if(i18n.encode)for(let e in i18n)"encode"!=e&&(i18n[e]=decodeURI(i18n[e]));var firefox=-1!=navigator.userAgent.toLowerCase().indexOf("firefox"),curRequests=[],useIframe=!1,iframeSandbox=!1,iframeInit=!1,filterListContainer,txtDownContent,txtDownWords,txtDownQuit,dacLinksCon,dacUseIframe,shadowContainer,downTxtShadowContainer;const escapeHTMLPolicy=win.trustedTypes&&win.trustedTypes.createPolicy?win.trustedTypes.createPolicy("dac_default",{createHTML:(e,t)=>e}):null;function createHTML(e){return escapeHTMLPolicy?escapeHTMLPolicy.createHTML(e):e}function str2Num(e){if(!(e=e.replace(/^番\s*外/,"99999+").replace(/[一①Ⅰ壹]/g,"1").replace(/[二②Ⅱ贰]/g,"2").replace(/[三③Ⅲ叁]/g,"3").replace(/[四④Ⅳ肆]/g,"4").replace(/[五⑤Ⅴ伍]/g,"5").replace(/[六⑥Ⅵ陆]/g,"6").replace(/[七⑦Ⅶ柒]/g,"7").replace(/[八⑧Ⅷ捌]/g,"8").replace(/[九⑨Ⅸ玖]/g,"9").replace(/[十⑩Ⅹ拾]/g,"*10+").replace(/[百佰]/g,"*100+").replace(/[千仟]/g,"*1000+").replace(/[万萬]/g,"*10000+").replace(/\s/g,"").match(/[\d\*\+]+/)))return 0;let t=(e=e[0]).match(/(\d*)\*(\d+)/);for(;t;){let n=parseInt(t[1]||1)*parseInt(t[2]);t=(e=e.replace(t[0],n)).match(/(\d+)\*(\d+)/)}let n=e.match(/(\d+)\+(\d+)/);for(;n;){let t=parseInt(n[1])+parseInt(n[2]);n=(e=e.replace(n[0],t)).match(/(\d+)\+(\d+)/)}return parseInt(e)}var dragOverItem,dragFrom,linkDict;function createLinkItem(e){let t=document.createElement("div");t.innerHTML=createHTML(`\n                <input type="checkbox" checked>\n                <a class="dacLink" draggable="false" target="_blank" href="${e.href}">${e.innerText||"📄"}</a>\n                <span>🖱️</span>\n            `),t.title=e.innerText,t.setAttribute("draggable","true"),t.addEventListener("dragover",(e=>{e.preventDefault()})),t.addEventListener("dragenter",(e=>{dragOverItem&&(dragOverItem.style.opacity=""),t.style.opacity=.3,dragOverItem=t})),t.addEventListener("dragstart",(e=>{dragFrom=t})),t.addEventListener("drop",(e=>{dragFrom&&(e.clientX<t.getBoundingClientRect().left+142?dacLinksCon.insertBefore(dragFrom,t):t.nextElementSibling?dacLinksCon.insertBefore(dragFrom,t.nextElementSibling):dacLinksCon.appendChild(dragFrom),e.preventDefault())})),linkDict[e.href]=t,dacLinksCon.appendChild(t)}var saveAsZip=!0;function filterList(e){if(GM_getValue("showFilterList")){if(txtDownContent&&(txtDownContent.style.display="none"),filterListContainer)filterListContainer.style.display="",filterListContainer.classList.remove("customRule"),dacLinksCon.innerHTML=createHTML("");else{document.addEventListener("dragend",(e=>{dragOverItem&&(dragOverItem.style.opacity="")}),!0),(filterListContainer=document.createElement("div")).id="filterListContainer",filterListContainer.innerHTML=createHTML(`\n                <div id="dacFilterBg" style="height: 100%; width: 100%; position: fixed; top: 0; z-index: 2147483646; opacity: 0.3; filter: alpha(opacity=30); background-color: #000;"></div>\n                <div id="filterListBody">\n                    <div class="dacCustomRule">\n                    ${i18n.custom}\n                        <textarea id="dacCustomInput"></textarea>\n                        <div class="fun">\n                            <input id="dacConfirmRule" value="${i18n.ok}" type="button"/>\n                            <input id="dacCustomClose" value="${i18n.close}" type="button"/>\n                        </div>\n                    </div>\n                    <div class="sort">\n                        <input id="dacSortByPos" value="${i18n.dacSortByPos}" type="button"/>\n                        <input id="dacSortByUrl" value="${i18n.dacSortByUrl}" type="button"/>\n                        <input id="dacSortByName" value="${i18n.dacSortByName}" type="button"/>\n                        <input id="reverse" value="${i18n.reverse}" type="button"/>\n                    </div>\n                    <div id="dacLinksCon" style="max-height: calc(80vh - 100px); min-height: 100px; display: grid; grid-template-columns: auto auto; width: 100%; overflow: auto; white-space: nowrap;"></div>\n                    <p style="margin: 5px; text-align: center; font-size: 14px; height: 20px;"><span><input id="dacUseIframe" type="checkbox"/><label for="dacUseIframe"> ${i18n.dacUseIframe}</label></span> <span style="display:${win.downloadAllContentSaveAsZip?"inline":"none"}"><input id="dacSaveAsZip" type="checkbox" checked="checked"/><label for="dacSaveAsZip"> ${i18n.dacSaveAsZip}</label></span></p>\n                    <div class="fun">\n                        <input id="dacSetCustomRule" value="${i18n.dacSetCustomRule}" type="button"/>\n                        <input id="dacAddUrl" value="${i18n.dacAddUrl}" type="button"/>\n                        <input id="dacStartDownload" value="${i18n.dacStartDownload}" type="button"/>\n                        <input id="dacLinksClose" value="${i18n.close}" type="button"/>\n                    </div>\n                </div>`);let t=filterListContainer.querySelector("#dacSortByPos"),n=filterListContainer.querySelector("#dacSortByUrl"),r=filterListContainer.querySelector("#dacSortByName"),o=filterListContainer.querySelector("#reverse"),a=filterListContainer.querySelector("#dacSetCustomRule"),i=filterListContainer.querySelector("#dacCustomInput"),l=filterListContainer.querySelector("#dacConfirmRule"),s=filterListContainer.querySelector("#dacCustomClose"),c=filterListContainer.querySelector("#dacAddUrl"),d=filterListContainer.querySelector("#dacStartDownload"),D=filterListContainer.querySelector("#dacLinksClose"),u=filterListContainer.querySelector("#dacFilterBg"),f=filterListContainer.querySelector("#dacSaveAsZip");dacUseIframe=filterListContainer.querySelector("#dacUseIframe"),f.onchange=e=>{saveAsZip=f.checked},t.onclick=t=>{[].slice.call(dacLinksCon.children)[0].children[1].href!=e[0].href?e.reverse().forEach((e=>{let t=linkDict[e.href];t&&dacLinksCon.insertBefore(t,dacLinksCon.children[0])})):e.forEach((e=>{let t=linkDict[e.href];t&&dacLinksCon.insertBefore(t,dacLinksCon.children[0])}))},n.onclick=e=>{let t=[].slice.call(dacLinksCon.children);t.sort(((e,t)=>{const n=e.children[1].href.toUpperCase(),r=t.children[1].href.toUpperCase();return n<r?-1:n>r?1:0})),t[0]==dacLinksCon.children[0]&&(t=t.reverse()),t.forEach((e=>{dacLinksCon.appendChild(e)}))},r.onclick=e=>{let t=[].slice.call(dacLinksCon.children);t.sort(((e,t)=>str2Num(e.innerText)-str2Num(t.innerText))),t[0]==dacLinksCon.children[0]&&(t=t.reverse()),t.forEach((e=>{dacLinksCon.appendChild(e)}))},o.onclick=e=>{[].slice.call(dacLinksCon.children).forEach((e=>{e.children[0].checked=!e.children[0].checked}))},a.onclick=e=>{filterListContainer.classList.add("customRule"),i.value=GM_getValue("DACrules_"+document.domain)||""},l.onclick=e=>{i.value&&customDown(i.value)},s.onclick=e=>{filterListContainer.classList.remove("customRule")},c.onclick=e=>{let t=window.prompt(i18n.customInfo,"https://xxx.xxx/book-[20-99].html, https://xxx.xxx/book-[01-10].html");if(!t||!/^http|^ftp/.test(t))return;let n=1;[].forEach.call(t.split(","),(function(e){var t,r=/\[\d+\-\d+\]/.exec(e);if(!r)return(t=document.createElement("a")).href=e,t.innerText="Added Url",void createLinkItem(t);r=r[0].trim();var o=/\[(\d+)/.exec(r)[1].trim(),a=/(\d+)\]/.exec(r)[1].trim(),i=parseInt(o),l=parseInt(a),s=o.length,c="0"==o.charAt(0);if(!(i>=l))for(var d=i;d<=l;d++){var D=d.toString();if(c)for(;D.length<s;)D="0"+D;var u=e.replace(/\[\d+\-\d+\]/,D).trim();(t=document.createElement("a")).href=u,t.innerText="Added Url "+n++,createLinkItem(t)}}))},d.onclick=e=>{let t=[].slice.call(dacLinksCon.querySelectorAll("input:checked+.dacLink"));useIframe=!!dacUseIframe.checked,indexDownload(t,!0)},D.onclick=e=>{filterListContainer.style.display="none"},u.onclick=e=>{filterListContainer.style.display="none"};let h=GM_addStyle("\n                #filterListContainer * {\n                    font-size: 13px;\n                    float: initial;\n                    background-image: initial;\n                    height: fit-content;\n                    color: black;\n                }\n                #filterListContainer.customRule .dacCustomRule {\n                    display: flex;\n                }\n                #filterListContainer .dacCustomRule>textarea {\n                    height: 300px;\n                    width: 100%;\n                    border: 1px #DADADA solid;\n                    background: #ededed70;\n                    margin: 5px;\n                }\n                #filterListContainer.customRule .dacCustomRule~* {\n                    display: none!important;\n                }\n                #dacLinksCon>div {\n                    padding: 5px 0;\n                    display: flex;\n                }\n                #dacLinksCon>div>a {\n                    max-width: 245px;\n                    display: inline-block;\n                    text-overflow: ellipsis;\n                    overflow: hidden;\n                }\n                #dacLinksCon>div>input {\n                    margin-right: 5px;\n                }\n                #filterListContainer .dacCustomRule {\n                    border-radius: 8px;\n                    font-weight: bold;\n                    font-size: 16px;\n                    outline: none;\n                    align-items: center;\n                    flex-wrap: nowrap;\n                    white-space: nowrap;\n                    flex-direction: column;\n                    display: none;\n                }\n                #filterListContainer input {\n                    border-width: 2px;\n                    border-style: outset;\n                    border-color: buttonface;\n                    border-image: initial;\n                    border: 1px #DADADA solid;\n                    padding: 5px;\n                    border-radius: 8px;\n                    font-weight: bold;\n                    font-size: 9pt;\n                    outline: none;\n                    cursor: pointer;\n                    line-height: initial;\n                    width: initial;\n                    min-width: initial;\n                    max-width: initial;\n                    height: initial;\n                    min-height: initial;\n                    max-height: initial;\n                }\n                #dacLinksCon>div:nth-of-type(4n),\n                #dacLinksCon>div:nth-of-type(4n+1) {\n                    background: #ffffff;\n                }\n                #dacLinksCon>div:nth-of-type(4n+2),\n                #dacLinksCon>div:nth-of-type(4n+3) {\n                    background: #f5f5f5;\n                }\n                #filterListContainer .fun,#filterListContainer .sort {\n                    display: flex;\n                    justify-content: space-around;\n                    flex-wrap: nowrap;\n                    width: 100%;\n                    height: 28px;\n                }\n                #filterListContainer input[type=button]:hover {\n                    border: 1px #C6C6C6 solid;\n                    box-shadow: 1px 1px 1px #EAEAEA;\n                    color: #333333;\n                    background: #F7F7F7;\n                }\n                #filterListContainer input[type=button]:active {\n                    box-shadow: inset 1px 1px 1px #DFDFDF;\n                }\n                #filterListBody {\n                    padding: 5px;\n                    box-sizing: border-box;\n                    overflow: hidden;\n                    width: 600px;\n                    height: auto;\n                    max-height: 80vh;\n                    min-height: 200px;\n                    position: fixed;\n                    left: 50%;\n                    top: 10%;\n                    margin-left: -300px;\n                    z-index: 2147483646;\n                    background-color: #ffffff;\n                    border: 1px solid #afb3b6;\n                    border-radius: 10px;\n                    opacity: 0.95;\n                    filter: alpha(opacity=95);\n                    box-shadow: 5px 5px 20px 0px #000;\n                }\n                @media screen and (max-width: 800px) {\n                    #filterListBody {\n                        width: 90%;\n                        margin-left: -45%;\n                    }\n                }\n            ");dacLinksCon=filterListContainer.querySelector("#dacLinksCon"),(shadowContainer=document.createElement("div")).id="download-all-content",document.body.appendChild(shadowContainer);let p=shadowContainer.attachShadow({mode:"open"});p.appendChild(h),p.appendChild(filterListContainer)}shadowContainer.parentNode&&shadowContainer.parentNode.removeChild(shadowContainer),linkDict={},e.forEach((e=>{createLinkItem(e)})),dacUseIframe.checked=useIframe,document.body.appendChild(shadowContainer)}else indexDownload(e)}function initTxtDownDiv(){if(txtDownContent)return txtDownContent.style.display="",void document.body.appendChild(downTxtShadowContainer);(txtDownContent=document.createElement("div")).id="txtDownContent",downTxtShadowContainer=document.createElement("div"),document.body.appendChild(downTxtShadowContainer),downTxtShadowContainer.attachShadow({mode:"open"}).appendChild(txtDownContent),txtDownContent.innerHTML=createHTML(`\n            <style>\n            #txtDownContent>div{\n              font-size:16px;\n              color:#333333;\n              width:342px;\n              height:110px;\n              position:fixed;\n              left:50%;\n              top:50%;\n              margin-top:-25px;\n              margin-left:-171px;\n              z-index:2147483647;\n              background-color:#ffffff;\n              border:1px solid #afb3b6;\n              border-radius:10px;\n              opacity:0.95;\n              filter:alpha(opacity=95);\n              box-shadow:5px 5px 20px 0px #000;\n            }\n            #txtDownWords{\n              position:absolute;\n              width:275px;\n              height: 90px;\n              max-height: 90%;\n              border: 1px solid #f3f1f1;\n              padding: 8px;\n              border-radius: 10px;\n              overflow: auto;\n            }\n            #txtDownQuit{\n              width: 30px;height: 30px;border-radius: 30px;position:absolute;right:2px;top:2px;cursor: pointer;background-color:#ff5a5a;\n            }\n            #txtDownQuit>span{\n              height: 30px;line-height: 30px;display:block;color:#FFF;text-align:center;font-size: 12px;font-weight: bold;font-family: arial;background: initial; float: initial;\n            }\n            #txtDownQuit+div{\n              position:absolute;right:0px;bottom:2px;cursor: pointer;max-width:85px;\n            }\n            #txtDownQuit+div>button{\n              background: #008aff;border: 0;padding: 5px;border-radius: 6px;color: white;float: right;margin: 1px;height: 25px;line-height: 16px;cursor: pointer;overflow: hidden;\n            }\n            </style>\n            <div>\n                <div id="txtDownWords">\n                    Analysing......\n                </div>\n                <div id="txtDownQuit">\n                    <span>╳</span>\n                </div>\n                <div>\n                    <button id="abortRequest" style="display:none;">${getI18n("abort")}</button>\n                    <button id="tempSaveTxt">${getI18n("save")}</button>\n                    <button id="saveAsMd" title="${getI18n("saveAsMd")}">Markdown</button>\n                    <button id="saveAsJSON" title="${getI18n("saveAsJSON")}">JSON</button>\n                </div>\n            </div>`),txtDownWords=txtDownContent.querySelector("#txtDownWords"),(txtDownQuit=txtDownContent.querySelector("#txtDownQuit")).onclick=function(){txtDownContent.style.display="none"},initTempSave(txtDownContent),win.txtDownWords=txtDownWords}function saveContent(){if(win.downloadAllContentSaveAsZip&&saveAsZip)win.downloadAllContentSaveAsZip(rCats,i18n.info.replace("#t#",location.href),(e=>{saveAs(e,document.title.replace(/[\*\/:<>\?\\\|\r\n,]/g,"_")+".zip")}));else{var e=new Blob([i18n.info.replace("#t#",location.href)+"\r\n\r\n"+rCats.join("\r\n\r\n")],{type:"text/plain;charset=utf-8"});saveAs(e,document.title.replace(/[\*\/:<>\?\\\|\r\n,]/g,"_")+".txt")}}function initTempSave(e){var t=e.querySelector("#tempSaveTxt"),n=e.querySelector("#abortRequest"),r=e.querySelector("#saveAsMd"),o=e.querySelector("#saveAsJSON");t.onclick=function(){saveContent(),console.log(curRequests)},n.onclick=function(){let e=curRequests.pop();e&&e[1].abort()},r.onclick=function(){let e=i18n.info.replace("#t#",location.href)+"\n\n---\n"+document.title+"\n===\n";rCats.forEach((t=>{t=t.replace("\r\n","\n---").replace(/(\r\n|\n\r)+/g,"\n\n").replace(/[\n\r]\t+/g,"\n"),e+="\n\n"+t}));var t=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(t,document.title.replace(/[\*\/:<>\?\\\|\r\n,]/g,"_")+".md")},o.onclick=function(){let e=[];rCats.forEach((t=>{let n=t.split("\r\n",3),r=GM_getValue("saveUrl"),o={title:n[0].trim(),content:n[1].trim()};r&&(o={title:n[0].trim(),url:n[1].trim(),content:n[2].trim()}),e.push(o)})),e=JSON.stringify(e,null,2);var t=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(t,document.title.replace(/[\*\/:<>\?\\\|\r\n,]/g,"_")+".json")}}let charset=document.characterSet||document.charset||document.inputEncoding,equiv=document.querySelector('[http-equiv="Content-Type"]'),charsetValid=!0;if(equiv&&equiv.content){let t=equiv.content.match(/charset\=([^;]+)/);t?t[1].replace("-","").toLowerCase()!=charset.replace("-","").toLowerCase()&&(charsetValid=!1):charsetValid=!1}else charsetValid=!1;function indexDownload(e,t){if(e.length<1)return;initTxtDownDiv(),t||(GM_getValue("contentSort")&&e.sort(((e,t)=>str2Num(e.innerText)-str2Num(t.innerText))),GM_getValue("contentSortUrl")&&e.sort(((e,t)=>{const n=e.href.toUpperCase(),r=t.href.toUpperCase();return n<r?-1:n>r?1:0})),GM_getValue("reverse")&&(e=e.reverse())),rCats=[];var n=GM_getValue("minTxtLength")||100,r=GM_getValue("customTitle"),o=GM_getValue("prefix"),a=!!GM_getValue("disableNextPage"),i=GM_getValue("nextPageReg"),l=GM_getValue("maxDlPerMin")||0,s=0;if(i)try{innerNextPage=new RegExp(i)}catch(e){console.warn(e)}var c=1;function d(e,t){if(r)try{let n=e.querySelector(r);n&&n.innerText&&(t.innerText=n.innerText)}catch(e){console.warn(e)}o&&(t.innerText=o.replace(/\$i/g,c)+t.innerText,c++)}var D,u=[],f=0,h=0,p=function(t){if(h>=e.length)return;if(l){if(-1===s)return void setTimeout((()=>{p(t)}),6e4);if(s>=l)return s=-1,void setTimeout((()=>{s=0,p(t)}),6e4);s++}let n=f,r=e[n],o=(n,r)=>{n&&n.cloneNode&&(n=n.cloneNode(!0));let o=0,i=0;if(useIframe){let o,l=document.createElement("iframe"),s=!1,c=0,D=e=>{l.src=e,clearTimeout(o),o=setTimeout((()=>{l.src=e}),2e4)};l.name="pagetual-iframe",l.width="100%",l.height="1000",l.frameBorder="0",l.sandbox=iframeSandbox||"allow-same-origin allow-scripts allow-popups allow-forms",l.style.cssText="margin:0!important;padding:0!important;visibility:hidden!important;flex:0;opacity:0!important;pointer-events:none!important;position:fixed;top:0px;left:0px;z-index:-2147483647;",l.addEventListener("load",(m=>{async function g(){try{let o=l.contentDocument||l.contentWindow.document;if(!o||!o.body)return void setTimeout((()=>{g()}),1e3);if(o.body.scrollTop=9999999,o.documentElement.scrollTop=9999999,!processFunc&&i++>5&&c++<2)return D(l.src),i=0,void(s=!1);let m=o.querySelector("base"),v=!a&&!processFunc&&await checkNextPage(o,m?m.href:n.href);if(v&&(v.length||(v=[v]),v.forEach((t=>{for(var o=!1,a=0;a<e.length;a++)if(e[a].href==t.href){o=!0;break}if(!o){t.innerText=n.innerText+"\t>>",e.push(t);let o=r;for(let e=0;e<u.length;e++){let t=u[e],n=!1;if(t)for(let a=0;a<t.length;a++){if(t[a]==r){o=e,n=!0;break}}if(n)break}u[o]||(u[o]=[]),u[o].push(e.length-1)}}))),d(o,n),f++,h++,!A(r,n,o,"",c<2))return f--,h--,void setTimeout((()=>{g()}),1e3);t?setTimeout((()=>{p(t)}),t):p()}catch(e){console.debug("Stop as cors")}l&&l.parentNode&&l.parentNode.removeChild(l)}"pagetual-iframe:DOMLoaded"!=m.data&&"load"!=m.type||s||(s=!0,clearTimeout(o),setTimeout((()=>{g()}),500))}),!1);let m=setInterval((()=>{let e;try{e=l.contentDocument||l.contentWindow&&l.contentWindow.document}catch(e){return void clearInterval(m)}if(e)try{Function("win","iframe",'"use strict";'+(iframeInit||"win.self=win.top;"))(l.contentWindow,l),clearInterval(m)}catch(e){console.debug(e)}}),50);return D(n.href),document.body.appendChild(l),[r,null,n.href]}return[r,function l(s){return s||(s=charset),GM_xmlhttpRequest({method:"GET",url:n.href,headers:{referer:n.href,"Content-Type":"text/html;charset="+s},timeout:1e4,overrideMimeType:"text/html;charset="+s,onload:async function(o){let c=function(e){var t=null;try{(t=document.implementation.createHTMLDocument("")).documentElement.innerHTML=e}catch(e){console.log("parse error")}return t}(o.responseText);if(charsetValid){let e=c.querySelector('[http-equiv="Content-Type"]');if(e&&e.content){let t=e.content.match(/charset\=([^;]+)/);if(t&&t[1].replace("-","").toLowerCase()!=s.replace("-","").toLowerCase())return charset=t[1],l(charset)}}f++,h++,/^{/.test(o.responseText)&&(c.json=()=>{try{return JSON.parse(o.responseText)}catch(e){}return{}});let D=c.querySelector("base"),m=!a&&!processFunc&&await checkNextPage(c,D?D.href:n.href);if(m&&(m.length||(m=[m]),m.forEach((t=>{for(var o=!1,a=0;a<e.length;a++)if(e[a].href==t.href){o=!0;break}if(!o){t.innerText=n.innerText+"\t>>",e.push(t);let o=r;for(let e=0;e<u.length;e++){let t=u[e],n=!1;if(t)for(let a=0;a<t.length;a++)if(t[a]==r){o=e,n=!0;break}if(n)break}u[o]||(u[o]=[]),u[o].push(e.length-1)}}))),o.status>=400?console.warn("error:",`status: ${o.status} from: ${n.href}`):console.log(o.status),d(c,n),!A(r,n,c,o.status>=400?` status: ${o.status} from: ${n.href} `:"",i<5)&&i++<5)return f--,h--,void setTimeout((()=>{l()}),500*Math.random()+1e3*i);t?setTimeout((()=>{p(t)}),t):p()},onerror:function(e){console.warn("error:",e,n.href),o++<5?setTimeout((()=>{l()}),500*Math.random()+1e3*o):(f++,h++,A(r,n,null,` NETWORK ERROR: ${e.response||e.responseText} from: ${n.href} `),t?setTimeout((()=>{p(t)}),t):p())},ontimeout:function(e){console.warn("timeout: times="+(o+1)+" url="+n.href),o++<5?setTimeout((()=>{l()}),500*Math.random()+1e3*o):(f++,h++,A(r,n,null,` TIMEOUT: ${n.href} `),t?setTimeout((()=>{p(t)}),t):p())}})}(),n.href]};if(!r){let t=setInterval((function(){h>=e.length&&clearInterval(t),r=e[n],r&&(clearInterval(t),o(r,n))}),1e3);return null}let i=o(r,n);return i&&curRequests.push(i),i};function A(t,r,o,a,i){let l=n=>{let o="";GM_getValue("saveUrl")&&(o=r.href+"\r\n"),rCats[t]=r.innerText.replace(/[\r\n\t]/g,"")+"\r\n"+o+(a||"")+n.replace(/\s*$/,""),curRequests=curRequests.filter((function(e){return e[0]!=t})),txtDownContent.style.display="block",txtDownWords.innerHTML=getI18n("downloading",[h,e.length-h,r.innerText]),h==e.length&&(D&&clearTimeout(D),D=setTimeout((()=>{h==e.length&&(txtDownWords.innerHTML=getI18n("complete",[h]),function(){var e,t,n=[];for(e=0;e<u.length;e++){var r=u[e];if(r)for(t=0;t<r.length;t++){var o=r[t],a=rCats[o];rCats[o]=null,n[e]||(n[e]=[]),n[e].push(a)}}for(e=n.length-1;e>=0;e--){let r=n[e];if(r)for(t=r.length-1;t>=0;t--)rCats.splice(e+1,0,r[t])}rCats=rCats.filter((function(e){return null!=e}))}(),GM_getValue("disableAutoStartSave")||saveContent())}),3e3))},s=getPageContent(o,(e=>{l(e)}),r.href);if(!1!==s){if(i&&s&&s.replace(/\s/g,"").length<n)return!1;l(s)}return!0}var m=parseInt(GM_getValue("downThreadNum"));if(m=m||20,useIframe&&m>5&&(m=5),m>0)for(var g=0;g<m&&(p(),!(f>=e.length-1||f>=m-1));g++)f++;else p(1e3*-m)}function canonicalUri(e,t){if(!e)return"";if("#"==e.charAt(0))return t+e;if("?"==e.charAt(0))return t.replace(/^([^\?#]+).*/,"$1"+e);let n=location.protocol+"//"+location.host,r=t||n;r=r.replace(/(\?|#).*/,""),/https?:\/\/[^\/]+$/.test(r)&&(r+="/"),0!==r.indexOf("http")&&(r=n+r);for(var o=/^[^\?#]*\//.exec(r)[0],a=/^\w+\:\/\/\/?[^\/]+/.exec(o)[0];0===e.indexOf("../");)e=e.substr(3),o=o.replace(/\/[^\/]+\/$/,"/");return e=e.replace(/\.\//,""),/^\/\/\/?/.test(e)&&(e=location.protocol+e),/^\w+\:\/\//.test(e)?e:("/"==e.charAt(0)?a:o)+e}async function checkNextPage(e,t){let n=null;if(nextPageFunc)n=await nextPageFunc(e,t),n&&0===n.length&&(n=null);else{let o=e.querySelectorAll("a");for(var r=0;r<o.length;r++){let e=o[r];if(innerNextPage.test(e.innerText)&&e.href&&!/javascript:|#/.test(e.href)){let r=canonicalUri(e.getAttribute("href"),t||location.href);if(r!=location.href){n=e,n.href=r;break}}}}return n}function textNodesUnder(e){for(var t,n=[],r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);t=r.nextNode();)n.push(t);return n}function getPageContent(e,t,n){if(!e)return i18n.error;if(e.body&&!e.body.children.length)return e.body.innerText;if(processFunc)return processFunc(e,t,n);[].forEach.call(e.querySelectorAll("span,div,ul"),(function(t){var n=e.defaultView?e.defaultView.getComputedStyle(t):t.style;n&&("none"==n.display||"SPAN"==t.nodeName&&"0px"==n.fontSize)&&(t.innerHTML="")}));var r,o,a,i="",l=(e.body?e.body:e).cloneNode(!0);l.innerHTML=l.innerHTML.replace(/\<\!\-\-((.|[\n|\r|\r\n])*?)\-\-\>/g,""),[].forEach.call(l.querySelectorAll("font.jammer"),(function(e){e.innerHTML=""}));var s=GM_getValue("selectors");s&&[].forEach.call(l.querySelectorAll(s),(function(e){e.innerHTML=""})),[].forEach.call(l.querySelectorAll("script,style,link,noscript,iframe"),(function(e){e&&e.parentNode&&e.parentNode.removeChild(e)}));var c,d=e=>/^(I|STRONG|B|FONT|P|DL|DD|H\d)$/.test(e.nodeName)&&e.children.length<=1,D=l.querySelectorAll("span,div,article,p,td,pre"),u=0;for(r=0;r<D.length;r++){let e,t=D[r],n=!1,i=!0,s=0;if(!/footer/.test(t.className)){for(o=t.childNodes.length-1;o>=0;o--)e=t.childNodes[o],3==e.nodeType?/^\s*$/.test(e.data)?e.innerHTML="":n=!0:(/^(I|A|STRONG|B|FONT|P|DL|DD|H\d)$/.test(e.nodeName)||1==e.nodeType&&1==e.children.length&&/^(I|A|STRONG|B|FONT|P|DL|DD|H\d)$/.test(e.children[0].nodeName))&&(n=!0);for(o=t.childNodes.length-1;o>=0;o--)e=t.childNodes[o],1==e.nodeType&&!/^(I|A|STRONG|B|FONT|BR)$/.test(e.nodeName)&&/^[\s\-\_\?\>\|]*$/.test(e.innerHTML)&&(e.innerHTML="");if(t.childNodes.length>1){let n=0;for(o=0;o<t.childNodes.length;o++)if(e=t.childNodes[o],1==e.nodeType){for(e.innerText&&e.innerText.length<50&&indexReg.test(e.innerText)&&n++,a=0;a<e.childNodes.length;a++){var f=e.childNodes[a];if(3!=f.nodeType&&!/^(I|A|STRONG|B|FONT|BR)$/.test(f.nodeName)){i=!1;break}}if(!i)break}if(n>=5)continue}else i=!1;(i||n)&&(l==document&&t.offsetWidth<=0&&t.offsetHeight<=0||([].forEach.call(t.childNodes,(function(e){3==e.nodeType?s+=e.data.trim().length:(d(e)||1==e.nodeType&&1==e.children.length&&d(e.children[0]))&&(s+=firefox?e.textContent.trim().length:e.innerText.trim().length)})),s>u&&(u=s,c=t)))}}if(!c)return i18n.error+" : NO TEXT CONTENT";var h=!!GM_getValue("retainImage");function p(){var e=l.querySelectorAll(c.nodeName);function t(e,t){[].forEach.call(e.querySelectorAll("a[href]"),(e=>{e.parentNode&&e.parentNode.removeChild(e)})),h&&[].forEach.call(e.querySelectorAll("img[src]"),(e=>{let t=document.createTextNode(`![img](${canonicalUri(e.getAttribute("src"),n||location.href)})`);e.parentNode.replaceChild(t,e)}));let r=e.childNodes,o="\r\n",a=!1;for(let e=0;e<r.length;e++){let t=r[e];3==t.nodeType&&t.data&&!/^[\s\-\_\?\>\|]*$/.test(t.data)&&(a=!0),t.innerHTML&&(t.innerHTML=t.innerHTML.replace(/\<\s*br\s*\>/gi,"\r\n").replace(/\n+/gi,"\n").replace(/\r+/gi,"\r"));let n=t.textContent;if(n){if(!n.trim())continue;o+=n.replace(/[\uFEFF\xA0 ]+/g," ").replace(/([^\r]|^)\n([^\r]|$)/gi,"$1\r\n$2")}3==t.nodeType||/^(I|A|STRONG|B|FONT|IMG)$/.test(t.nodeName)?t.nextSibling&&/^P$/.test(t.nextSibling.nodeName)&&(o+="\r\n"):o+="\r\n"}(a||t||e==c)&&(i+=o+"\r\n")}var o=[];for(r=0;r<e.length;r++){var a=e[r];if(getDepth(a)==getDepth(c)){if(c.className!=a.className)continue;o.push(a)}}var s=u>>2,d=o.length<=3;o.forEach((e=>{d&&e.innerText.length<s||(c.className&&c.className==e.className||c.parentNode==e.parentNode?t(e,!0):t(e,!1))})),i=i.replace(/[\n\r]+/g,"\n\r")}if(p(),i.length<100){let e=l.querySelectorAll("article");e&&1==e.length&&(c=e[0],(u=c.innerText.length)>100&&(i="",p()))}return i}function getI18n(e,t){var n=i18n[e];return t&&t.length>0&&t.forEach((function(e){n=n.replace(/%s/,e)})),n}function getDepth(e){for(var t=e,n=0;t.parentNode;)t=t.parentNode,n++;return n}async function sleep(e){await new Promise((t=>{setTimeout((()=>{t()}),e)}))}async function fetch(e){e=!0===e,processFunc=null,initTxtDownDiv();var t=document.body.querySelectorAll("a"),n=[];txtDownWords.innerHTML=`Analysing ( 1/${t.length} )......`,txtDownContent.style.pointerEvents="none";for(var r=0;r<t.length;r++){r%100==0&&await sleep(1),txtDownWords.innerHTML=`Analysing ( ${r+1}/${t.length} )......`;var o=t[r],a=!1;if(!o.dataset.href||o.href&&-1==o.href.indexOf("javascript")||(o.href=o.dataset.href),o.href!=location.href){for(var i=0;i<n.length;i++)if(n[i].href==o.href){o=n[i],n.splice(i,1),n.push(o),a=!0;break}!a&&o.href&&/^http/i.test(o.href)&&(""!=o.innerText.trim()&&indexReg.test(o.innerText.trim())||/chapter[\-_]?\d/.test(o.href))&&n.push(o)}}if(txtDownContent.style.display="none",txtDownContent.style.pointerEvents="",txtDownWords.innerHTML="Analysing......",n.length>2&&!e)useIframe=!1,filterList(n);else{var l=new Blob([i18n.info.replace("#t#",location.href)+"\r\n\r\n"+document.title+"\r\n\r\n"+getPageContent(document)],{type:"text/plain;charset=utf-8"});saveAs(l,document.title+".txt")}}function customDown(urls){if(processFunc=null,useIframe=!1,urls){urls=decodeURIComponent(urls.replace(/%/g,"%25")),GM_setValue("DACrules_"+document.domain,urls);var processEles=[];let urlsArr=urls.split("@@"),eles=[];if(/^http|^ftp/.test(urlsArr[0]))[].forEach.call(urlsArr[0].split(","),(function(e){var t,n=/\[\d+\-\d+\]/.exec(e);if(!n)return(t=document.createElement("a")).href=e,t.innerText="Added Url",void processEles.push(t);n=n[0].trim();var r=/\[(\d+)/.exec(n)[1].trim(),o=/(\d+)\]/.exec(n)[1].trim(),a=parseInt(r),i=parseInt(o),l=r.length,s="0"==r.charAt(0);if(!(a>=i))for(var c=a;c<=i;c++){var d=c.toString();if(s)for(;d.length<l;)d="0"+d;var D=e.replace(/\[\d+\-\d+\]/,d).trim();(t=document.createElement("a")).href=D,t.innerText="Added Url "+processEles.length.toString(),processEles.push(t)}}));else{let e=urlsArr[0].split(">>");try{eles=document.querySelectorAll(e[0]),eles=[].filter.call(eles,(e=>"BODY"==e.nodeName||!!e.offsetParent&&"none"!==getComputedStyle(e).display))}catch(n){}if(0==eles.length){eles=[];var eleTxts=urlsArr[0].split(/(?<=[^\\])[,，]/),exmpEles=[],excludeTxts={};[].forEach.call(document.querySelectorAll("a"),(function(e){e.offsetParent&&eleTxts.forEach((t=>{var n=t.split("!");-1!=e.innerText.indexOf(n[0])&&(exmpEles.push(e),excludeTxts[e]=n.splice(1))}))})),exmpEles.forEach((e=>{var t="a",n=e.parentNode,r=excludeTxts[e];for(e.className&&(t+="."+CSS.escape(e.className.replace(/\s+/g,".")).replace(/\\\./g,"."));n&&"BODY"!=n.nodeName;)t=n.nodeName+">"+t,n=n.parentNode;t="body>"+t,[].forEach.call(document.querySelectorAll(t),(function(e){if(e.offsetParent){var t=!1;for(var n in r)if(-1!=e.innerText.indexOf(r[n])){t=!0;break}t||-1!=eles.indexOf(e)||eles.push(e)}}))}))}function t(e){let t=!1;for(var n=0;n<processEles.length;n++)if(processEles[n].href==e.href){processEles.splice(n,1),processEles.push(e),t=!0;break}e.href&&-1==e.href.indexOf("javascript")||!e.dataset.href||(e.href=e.dataset.href),!t&&e.href&&/^http/i.test(e.href)&&processEles.push(e.cloneNode(1))}[].forEach.call(eles,(function(n){if(e[1]){let r;n=Function("item",e[1])(n),r=Array.isArray(n)?n:[n],r.forEach((e=>{if(e&&e.href){if(!e.nodeName||"A"!=e.nodeName){let t=e.href,n=e.innerText;(e=document.createElement("a")).href=t,e.innerText=n}t(e)}}))}else t(n)}))}urlsArr[1]&&processEles.forEach((e=>{e.href=e.href.replace(new RegExp(urlsArr[1]),urlsArr[2])}));var retainImage=!!GM_getValue("retainImage"),evalCode=urlsArr[3];if(evalCode){if(evalCode=evalCode.trim(),/^iframe:/.test(evalCode))for(evalCode=evalCode.replace("iframe:",""),useIframe=!0,iframeSandbox=!1,iframeInit=!1;/^(sandbox|init):/.test(evalCode);)iframeSandbox=evalCode.match(/^sandbox:\{(.*?)\}/),iframeSandbox&&(evalCode=evalCode.replace(iframeSandbox[0],""),iframeSandbox=iframeSandbox[1]),iframeInit=evalCode.match(/^init:\{(.*?)\}/),iframeInit&&(evalCode=evalCode.replace(iframeInit[0],""),iframeInit=iframeInit[1]);let r=evalCode.match(/^charset:{(.+?)}/);r&&(charset=r[1],evalCode=evalCode.replace(r[0],""));let o=evalCode.match(/^next:(\{+)/);if(o){let a=o[1].length;if(o=evalCode.match(new RegExp(`^next:\\{{${a}}(.*?)\\}{${a}}`)),o){let i=o[1];evalCode=evalCode.replace(o[0],""),nextPageFunc=async(e,t)=>{let n;if(/\breturn\b/.test(i))n=await new AsyncFunction("doc","url",'"use strict";'+i)(e,t);else try{n=e.querySelectorAll(i),n&&n.length?[].forEach.call(n,(e=>{e.href=canonicalUri(e.getAttribute("href"),t||location.href)})):n=null}catch(e){}return n}}}}evalCode?processFunc=(data,cb,url)=>{let doc=data;if(-1==evalCode.indexOf("return ")){if(0==evalCode.indexOf("@")){let e="";var selectors=GM_getValue("selectors");return selectors&&[].forEach.call(data.querySelectorAll(selectors),(function(e){e.innerHTML=""})),[].forEach.call(data.querySelectorAll("script,style,link,noscript,iframe"),(function(e){e&&e.parentNode&&e.parentNode.removeChild(e)})),retainImage&&[].forEach.call(data.querySelectorAll("img[src]"),(e=>{let t=`![img](${canonicalUri(e.getAttribute("src"),location.href)})`,n=document.createTextNode(t);e.parentNode.replaceChild(n,e)})),[].forEach.call(data.querySelectorAll(evalCode.slice(1)),(t=>{[].forEach.call(t.childNodes,(t=>{t.innerHTML&&(t.innerHTML=t.innerHTML.replace(/\<\s*br\s*\>/gi,"\r\n").replace(/\n+/gi,"\n").replace(/\r+/gi,"\r")),t.textContent&&(e+=t.textContent.replace(/ +/g," ").replace(/([^\r]|^)\n([^\r]|$)/gi,"$1\r\n$2")+"\r\n")})),e+="\r\n"})),e}return eval(evalCode)}return Function("data","doc","cb","url",evalCode)(data,doc,cb,url)}:win.dacProcess&&(processFunc=win.dacProcess),filterList(processEles)}}const configPage="https://hoothin.github.io/UserScripts/DownloadAllContent/",copySvg='<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" style="transition: all ease 0.5s;top: 5px;right: 5px;position: absolute;cursor: pointer;"><title>Copy</title><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';function searchRule(){GM_openInTab(configPage+"#@"+location.hostname,{active:!0})}var downloadShortcut=GM_getValue("downloadShortcut")||{ctrlKey:!0,shiftKey:!1,altKey:!1,metaKey:!1,key:"F9"},downloadSingleShortcut=GM_getValue("downloadSingleShortcut")||{ctrlKey:!0,shiftKey:!0,altKey:!1,metaKey:!1,key:"F9"},downloadCustomShortcut=GM_getValue("downloadCustomShortcut")||{ctrlKey:!0,shiftKey:!1,altKey:!0,metaKey:!1,key:"F9"},enableTouch=GM_getValue("enableTouch");if(enableTouch){const n=256,r=.5,o=2;var lastX,lastY,signs,lastSign;function a(e){let t=e.changedTouches[0].clientX,a=e.changedTouches[0].clientY,i=t-lastX,l=a-lastY;if(i*i+l*l>n){lastX=t,lastY=a;let e="",n=Math.abs(l/i);n>o?e=l>0?"↓":"↑":n<r&&(e=i>0?"→":"←"),e&&lastSign!=e&&(signs+=e,lastSign=e)}}document.addEventListener("touchstart",(function(e){lastX=e.changedTouches[0].clientX,lastY=e.changedTouches[0].clientY,lastSign=signs="",document.addEventListener("touchmove",a,!1)}),!1),document.addEventListener("touchend",(function(e){document.removeEventListener("touchmove",a,!1),"→↓←↑"==signs&&(e.stopPropagation(),e.preventDefault(),startCustom())}),!1)}if(location.origin+location.pathname==configPage){let i=document.getElementById("example");if(!i)return;i=i.parentNode;let l=i.nextElementSibling.nextElementSibling,s=document.createElement("input"),c;function d(){clearTimeout(c),c=setTimeout((()=>{let e=s.value,t=[],n=[];if(e)for(let r=0;r<l.children.length;r++){let o=l.children[r];-1==o.firstChild.href.indexOf(e)?n.push(o):t.push(o)}else n=l.children;if(t.length){for(let e=0;e<n.length;e++){n[e].style.display="none"}for(let e=0;e<t.length;e++){t[e].style.display=""}}else for(let e=0;e<n.length;e++){n[e].style.display=""}}),500)}if(s.style.margin="10px",s.style.width="100%",s.placeholder=i18n.searchRule,s.addEventListener("input",(function(e){d()})),location.hash){let q=location.hash.slice(1);0==q.indexOf("@")&&(setTimeout((()=>{i.scrollIntoView()}),500),s.value=q.slice(1),d())}[].forEach.call(l.querySelectorAll("div.highlight"),(e=>{e.style.position="relative",e.innerHTML=e.innerHTML+copySvg;let t=e.children[1];t.addEventListener("click",(function(n){GM_setClipboard(e.children[0].innerText),t.style.opacity=0,setTimeout((()=>{t.style.opacity=1}),1e3)}))})),i.parentNode.insertBefore(s,l);let D=document.querySelector("[alt='donate']");if(!D)return;let u=D.parentNode.nextElementSibling,f=0;function h(e,t,n){n||(n="input");let r=document.createElement("div"),o=document.createElement("input"),a=document.createElement("b");if(o.type=n,o.value=t,o.checked=t,a.style.margin="0px 10px 0px 0px","radio"==n){let t=document.createElement("label");t.innerText=e,f++,o.id="radio"+f,t.setAttribute("for",o.id),a.appendChild(t)}else"input"==n&&(o.style.flexGrow="1"),a.innerText=e;return r.style.margin="10px 0",r.style.display="flex",r.style.alignItems="center",r.appendChild(a),r.appendChild(o),u.parentNode.insertBefore(r,u),o}function p(e){let t=[];return e.ctrlKey&&t.push("Ctrl"),e.shiftKey&&t.push("Shift"),e.altKey&&t.push("Alt"),e.metaKey&&t.push("Meta"),t.push(e.key),t.join(" + ")}function A(e){if(!e)return"";let t={ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1,key:""};return e.split(" + ").forEach((e=>{switch(e){case"Ctrl":t.ctrlKey=!0;break;case"Shift":t.shiftKey=!0;break;case"Alt":t.altKey=!0;break;case"Meta":t.metaKey=!0;break;default:t.key=e}})),t}let m=h(i18n.showFilterList,!!GM_getValue("showFilterList"),"checkbox"),g=h(i18n.downloadShortcut,p(downloadShortcut)||""),v=h(i18n.downloadSingleShortcut,p(downloadSingleShortcut)||""),x=h(i18n.downloadCustomShortcut,p(downloadCustomShortcut)||"");g.setAttribute("readonly","true"),v.setAttribute("readonly","true"),x.setAttribute("readonly","true"),g.style.cursor="cell",v.style.cursor="cell",x.style.cursor="cell";let y=e=>{e.key&&("Backspace"==e.key?e.target.value="":"Control"!=e.key&&"Shift"!=e.key&&"Alt"!=e.key&&"Meta"!=e.key&&(e.target.value=p(e))),e.preventDefault(),e.stopPropagation()};g.addEventListener("keydown",y),v.addEventListener("keydown",y),x.addEventListener("keydown",y);let w=h(i18n.enableTouch,!!enableTouch,"checkbox"),S=h(i18n.del,GM_getValue("selectors")||"");S.setAttribute("placeHolder",".mask,.ksam");let C=h(i18n.downThreadNum,GM_getValue("downThreadNum")||"20","number"),b=h(i18n.maxDlPerMin,GM_getValue("maxDlPerMin")||"0","number"),T=h(i18n.customTitle,GM_getValue("customTitle")||""),k=h(i18n.saveUrl,!!GM_getValue("saveUrl"),"checkbox"),L=h(i18n.disableAutoStartSave,!!GM_getValue("disableAutoStartSave"),"checkbox");T.setAttribute("placeHolder","title");let B=h(i18n.minTxtLength,GM_getValue("minTxtLength")||"100","number"),M=GM_getValue("contentSortUrl")||!1,E=GM_getValue("contentSort")||!1,N=h(i18n.reSortDefault,!M&&!E,"radio"),I=h(i18n.reSortUrl,M||!1,"radio"),R=h(i18n.reSort,E||!1,"radio");N.name="sort",I.name="sort",R.name="sort";let F=h(i18n.reverseOrder,!!GM_getValue("reverse"),"checkbox"),_=h(i18n.prefix,GM_getValue("prefix")||""),G=!!GM_getValue("disableNextPage"),O=h(i18n.nextPage,!G,"checkbox"),U=h(i18n.nextPageReg,GM_getValue("nextPageReg")||""),P=h(i18n.retainImage,!!GM_getValue("retainImage"),"checkbox");_.setAttribute("placeHolder","第 $i 章："),U.setAttribute("placeHolder","^\\s*(下一[页頁张張]|next\\s*page|次のページ)"),G&&(U.parentNode.style.display="none"),O.onclick=e=>{U.parentNode.style.display=O.checked?"flex":"none"};let V=document.createElement("button");return V.innerText=i18n.saveBtn,V.style.margin="0 0 20px 0",u.parentNode.insertBefore(V,u),void(V.onclick=e=>{GM_setValue("selectors",S.value||""),GM_setValue("downThreadNum",parseInt(C.value||20)),GM_setValue("maxDlPerMin",parseInt(b.value||20)),GM_setValue("minTxtLength",parseInt(B.value||100)),GM_setValue("customTitle",T.value||""),GM_setValue("disableAutoStartSave",L.checked),GM_setValue("saveUrl",k.checked),I.checked?(GM_setValue("contentSortUrl",!0),GM_setValue("contentSort",!1)):R.checked?(GM_setValue("contentSortUrl",!1),GM_setValue("contentSort",!0)):(GM_setValue("contentSortUrl",!1),GM_setValue("contentSort",!1)),GM_setValue("reverse",F.checked),GM_setValue("enableTouch",w.checked),GM_setValue("retainImage",P.checked),GM_setValue("showFilterList",m.checked),GM_setValue("disableNextPage",!O.checked),GM_setValue("nextPageReg",U.value||""),GM_setValue("prefix",_.value||""),GM_setValue("downloadShortcut",A(g.value)||""),GM_setValue("downloadSingleShortcut",A(v.value)||""),GM_setValue("downloadCustomShortcut",A(x.value)||""),alert(i18n.saveOk)})}function setDel(){GM_openInTab(configPage+"#操作說明",{active:!0})}function checkKey(e,t){return e.ctrlKey==t.ctrlKey&&e.shiftKey==t.shiftKey&&e.altKey==t.altKey&&e.metaKey==t.metaKey&&e.key==t.key}function startCustom(){var e=GM_getValue("DACrules_"+document.domain),t=window.prompt(i18n.customInfo+":\nhttps://xxx.xxx/book-[20-99].html, https://xxx.xxx/book-[01-10].html",e||"");t&&customDown(t)}document.addEventListener("keydown",(function(e){checkKey(downloadCustomShortcut,e)?startCustom():checkKey(downloadSingleShortcut,e)?fetch(!0):checkKey(downloadShortcut,e)&&fetch(!1)})),GM_registerMenuCommand(i18n.custom,(()=>{startCustom()})),GM_registerMenuCommand(i18n.fetch,fetch),GM_registerMenuCommand(i18n.setting,setDel),GM_registerMenuCommand(i18n.searchRule,searchRule)}();