// ==UserScript==
// @name         Tiktok Video & Slideshow Downloader ðŸŽ¬ðŸ–¼ï¸
// @namespace    https://greasyfork.org/en/scripts/431826
// @version      2.9
// @description  Download TikTok videos without watermark and slideshow images
// @author       YAD
// @match        *://*.tiktok.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_download
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js
// @icon         https://miro.medium.com/v2/resize:fit:512/1*KX6NTUUHWlCP4sCXz28TBA.png
// @license      MIT
// @downloadURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Tiktok20Video20DownloaderF09F8EAC.user.js
// @updateURL https://raw.githubusercontent.com/FiorenMas/Userscripts/release/release/Tiktok20Video20DownloaderF09F8EAC.meta.js
// ==/UserScript==
!function(){"use strict";const e=document.createElement("style");e.innerHTML='\n        [id^="xgwrapper-"] {\n            height: 100% !important;\n        }\n    ',document.head.appendChild(e);const t=e=>`TikTok_Video_${e}.mp4`,o=(e,t,o)=>{const n=document.createElement("div");return Object.assign(n.style,{position:"absolute",right:"15px",top:"27%",transform:"translateY(-50%)",width:"50px",height:"50px",backgroundColor:t,color:"#ffffff",fontSize:"18px",textShadow:"3px 3px 0px #9C1331",textAlign:"center",lineHeight:"50px",borderRadius:"50%",cursor:"pointer",zIndex:"999999"}),n.textContent=e,n.onclick=o,n},n=(e,t,o,n=!1)=>{e?(o.textContent="â³",GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onload:({response:e})=>{e?n?t.file("video",e):GM_download({url:URL.createObjectURL(e),name:t,onload:()=>{o.textContent="âœ”ï¸",setTimeout((()=>o.remove()),2e3)},onerror:()=>{o.textContent="âœ–ï¸",setTimeout((()=>o.remove()),1500)}}):(o.textContent="âœ–ï¸",setTimeout((()=>o.remove()),1500))},onerror:()=>{o.textContent="âœ–ï¸",setTimeout((()=>o.remove()),1500)},ontimeout:()=>{o.textContent="âœ–ï¸",setTimeout((()=>o.remove()),1500)}})):o.textContent="âœ–ï¸"},r=e=>{let r;e.addEventListener("mouseover",(()=>{r||(r=(e=>{const r=o("ðŸŽžï¸","#ff3b5c",(async o=>{o.stopPropagation(),o.preventDefault(),r.textContent="â³";const s=e.src||e.querySelector("source")?.src,i=e.closest('[id^="xgwrapper-"]'),l=i?.id.split("-")[2]||"default";if(s&&s.startsWith("blob:")){r.style.backgroundColor="#ffa700";const e=`https://www.tiktok.com/@YAD/video/${l}`,o=document.createElement("iframe");o.style.position="fixed",o.style.width="80%",o.style.height="80%",o.style.top="10%",o.style.left="10%",o.style.border="2px solid #000",o.style.zIndex="10000",o.style.visibility="hidden",o.src=e,document.body.appendChild(o);const s=()=>{const e=o.contentDocument||o.contentWindow.document,i=e.querySelector("video"),d=e.querySelector("video source");i&&d&&d.src?(n(d.src,t(l),r),o.remove()):setTimeout(s,1e3)};o.onload=()=>{setTimeout(s,8e3)}}else r.style.backgroundColor="#ff3b5c",n(s,t(l),r)}));return e.parentNode.style.position="relative",e.parentNode.appendChild(r),r})(e))})),e.addEventListener("mouseout",(t=>{!r||e.contains(t.relatedTarget)||r.contains(t.relatedTarget)||"â³"!==r.textContent&&(r.remove(),r=null)}))},s=e=>{if(e.querySelector(".image-download-btn"))return;const t=o("ðŸ–¼ï¸","#16b1c6",(async()=>{t.textContent="âŒ›";const o=e.querySelectorAll("img");if(!o.length)return alert("No images found!"),void(t.textContent="âœ–ï¸");const n=Array.from(o).map((e=>e.src)),r=[...new Set(n)];if(await new Promise((e=>{e(confirm("Do you want to download images as a ZIP file? Cancel will download individually"))}))){const e=new JSZip;let o=0;r.forEach(((n,s)=>{GM_xmlhttpRequest({method:"GET",url:n,responseType:"blob",onload:n=>{e.file(`image${s+1}.jpeg`,n.response),o++,o===r.length&&e.generateAsync({type:"blob"}).then((e=>{const o=URL.createObjectURL(e);GM_download({url:o,name:"TikTok_Slideshow.zip"}),t.textContent="âœ”ï¸"}))}})}))}else r.forEach(((e,o)=>{GM_download({url:e,name:`image${o+1}.jpeg`,onload:()=>{t.textContent="âœ”ï¸"}})}))}));e.style.position="relative",e.appendChild(t)};new MutationObserver((()=>{document.querySelectorAll('div[class*="DivPhotoVideoContainer"]:not(.processed)').forEach((e=>{e.classList.add("processed"),s(e)}))})).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver((()=>{document.querySelectorAll("video:not(.processed)").forEach((e=>{e.classList.add("processed"),r(e)}))})).observe(document.body,{childList:!0,subtree:!0})}();